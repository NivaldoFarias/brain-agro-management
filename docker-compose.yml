services:
  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    container_name: brain-ag-api
    ports:
      - "${API__PORT:-3000}:3000"
    environment:
      # Runtime configuration
      NODE_ENV: ${NODE_ENV:-production}

      # Logging configuration
      API__LOG_LEVEL: ${API__LOG_LEVEL:-info}
      API__LOG_TO_CONSOLE: ${API__LOG_TO_CONSOLE:-true}

      # Server configuration
      API__PORT: 3000
      API__BASE_PATH: ${API__BASE_PATH:-/api}

      # Database configuration
      API__DATABASE_PATH: ${API__DATABASE_PATH:-./apps/api/data/agro.db}
      API__DATABASE_LOGGING: ${API__DATABASE_LOGGING:-false}
      API__DATABASE_SYNCHRONIZE: ${API__DATABASE_SYNCHRONIZE:-false}

      # Security configuration
      API__CORS_ORIGIN: ${API__CORS_ORIGIN:-http://localhost:5173}
      API__THROTTLE_TTL_MS: ${API__THROTTLE_TTL_MS:-60000}
      API__THROTTLE_LIMIT: ${API__THROTTLE_LIMIT:-100}

      # JWT configuration
      API__JWT_SECRET: ${API__JWT_SECRET:-change-me-in-production-use-minimum-32-characters-secret-key}
      API__JWT_EXPIRATION: ${API__JWT_EXPIRATION:-1h}

      # Database seeding (disable in production)
      API__SEED_DATABASE: ${API__SEED_DATABASE:-false}
    volumes:
      - api-data:/app/apps/api/data
      - api-logs:/app/apps/api/logs
      # Development: mount source code for hot reload (uncomment for dev)
      # - ./apps/api/src:/app/apps/api/src:ro
    networks:
      - brain-ag-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3000/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
  # Frontend web service (placeholder for future)
  # web:
  #   build:
  #     context: ../..
  #     dockerfile: apps/web/Dockerfile
  #   container_name: brain-ag-web
  #   ports:
  #     - "5173:80"
  #   depends_on:
  #     - api
  #   networks:
  #     - brain-ag-network
  #   restart: unless-stopped

networks:
  brain-ag-network:
    driver: bridge
    name: brain-ag-network

volumes:
  api-data:
    name: brain-ag-api-data
    driver: local
  api-logs:
    name: brain-ag-api-logs
    driver: local
